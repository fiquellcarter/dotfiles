#!/usr/bin/env bash

set -euo pipefail

SEARCH_DIRS=(
    "$HOME"
    "$HOME/programming/personal"
    "$HOME/programming/probe"
    "$HOME/programming/tries"
    "$HOME/programming/work"
)

switch_to_session() {
    if [[ -z "${TMUX:-}" ]]; then
        tmux attach-session -t "$1"
    else
        tmux switch-client -t "$1"
    fi
}

if [[ $# -eq 1 ]]; then
    selected="$1"
elif [[ $# -eq 0 ]]; then
    selected=$(find "${SEARCH_DIRS[@]}" -mindepth 1 -maxdepth 1 -type d 2>/dev/null | fzf)
else
    echo "ERROR: Usage: $(basename "$0") [directory]" >&2
    exit 2
fi

if [[ -z "$selected" ]]; then
    exit 0
fi

session_name=$(basename "$selected" | tr '.' '_')

if [[ -z "${TMUX:-}" ]] && ! pgrep tmux >/dev/null; then
    tmux new-session -s "$session_name" -c "$selected"
    exit 0
fi

if ! tmux has-session -t "$session_name" 2>/dev/null; then
    tmux new-session -ds "$session_name" -c "$selected"
fi

switch_to_session "$session_name"
